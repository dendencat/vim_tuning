#!/usr/bin/env bash
set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
[ -f "${repo_root}/.githooks.env" ] && source "${repo_root}/.githooks.env"

targets=( ".vimrc" "init.vim" )
changed=()

for t in "${targets[@]}"; do
  if ! git diff --cached --quiet -- "$t" 2>/dev/null; then
    changed+=("$t")
  fi
done

if [ "${#changed[@]}" -gt 0 ]; then
  echo "=== Staged diff for Vim configs ==="
  # less を使わず cat 相当で一気に出力
  git -c color.ui=always diff --cached -- "${changed[@]}"

  # 入力は必ず /dev/tty から受け取る
  read -r -p "Proceed with commit & deploy? [y/N] " ans < /dev/tty || ans=""

  case "$ans" in
    y|Y) ;;  # 承認
    *) echo "Abort commit."; exit 1;;
  esac
fi
